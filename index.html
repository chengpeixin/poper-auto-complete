<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no"/>    <title>Document</title>
</head>
<style>
html,body{
    width: 100vw;
    height: 100vh;
    box-sizing: border-box;
    /* 解决ios滑动卡顿 */
    -webkit-overflow-scrolling: touch;
    /* 开启gpu加速 */
    transform: translateZ(0);
}
body{
    overflow-y: overlay;
}
.scroll{
    display: grid;
    /* grid-gap: 5px; */
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}
.result-item-fullbox{
    padding: 2px;
    box-sizing: border-box;
    transition: all .3s;
}
.result-item{
    width: 98%;
    height: 130px;
    flex: 1;
    border-radius: 5px;
    max-width: 400px;
    margin: 0 auto;
    display: flex;
    padding: 16px;
    box-sizing: border-box;
    position: relative;
    box-shadow: 0 2px 12px 0 rgb(0 0 0 / 10%);
}
.result-item-img{
    height: 90px;
    width: 90px;
}
.result-item-img img{
    width: 90px;
    height: 90px;
    border-radius: 5px;
    opacity:0;
    transition: opacity 1s ease; 
}
.result-item-content{
    width: 70%;
    color: #333;
}
.result-item-content-title{
    font-size: 16px;
    font-weight: 700;
}
.result-item-content-text{
    display:block;
    font-size: 14px;
    text-overflow:ellipsis;
    padding-right: 8px;
    box-sizing: border-box;
    overflow: hidden;
    display:-webkit-box;
    -webkit-line-clamp:3;/*要显示的行数*/
    -webkit-box-orient:vertical;
}
.result-item-date{
    position: absolute;
    bottom: 16px;
    font-size: 14px;
    color: #999;
}
.next-page{
    width: 100%;
    height: 50px;
    cursor: pointer;
    color: #93969a;
    background: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
}
.next-page-text{
    display: none;
}
.spinner {
  width: 40px;
  height: 40px;
  animation: rotate 2s linear infinite;
  display: block;
}
.spinner .path {
  stroke: #93bfec;
  stroke-linecap: round;
  animation: dash 1.5s ease-in-out infinite;
}
@keyframes rotate {
  100% {
    transform: rotate(360deg);
  }
}

@keyframes dash {
  0% {
    stroke-dasharray: 1, 150;
    stroke-dashoffset: 0;
  }

  50% {
    stroke-dasharray: 90, 150;
    stroke-dashoffset: -35;
  }

  100% {
    stroke-dasharray: 90, 150;
    stroke-dashoffset: -124;
  }
}
.skeleton{
    /* 骨架 */
    background-image: linear-gradient(90deg, #efecee 25%, #fff 37%, #efecee 63%);
    background-size: 400% 100%;
    background-position: 100% 50%;
    animation: skeleton-loading 1.4s ease infinite;
}
@keyframes skeleton-loading {
  0% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0 50%;
  }
}

</style>
<body>
    <div id="xxx"></div>
    <div class="scroll"></div>
    <div class="next-page">
        <span class="next-page-text">下一页</span>
        <svg class="spinner" viewBox="0 0 50 50">
            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
          </svg>
    </div>
</body>
</html>
<script type="module" src="src/index.ts"></script>

<script>

const testData = []
for(let i=0;i<100000;i++){
    testData.push({
        label: `${i}hcdfj`,
        value: String(i)
    })
}
window.addEventListener('load',function(){
    const autoComplete = new AutoComplete(document.querySelector('#xxx'),{
        options:testData,
        width:'100%',
        height:50
    })

    var paging = {
        current:0,
        pageSize:10,
        total:0
    }
    autoComplete.on('change',(data)=>{
        const fullScroll = document.querySelector('.scroll')
        fullScroll.innerHTML = ''
        hideNextText()
        showLoading()
        // 这里是传出的属性
        loadNewsData()
        Object.assign(paging,{
            current:0,
            pageSize:10,
            total:0
        })
    })

    loadNewsData()

    // 懒加载图片
    const lazyload = () => {
        const imgLazyElements = document.querySelectorAll('img[lazy]')
        Array.prototype.forEach.call(imgLazyElements,function(item,index){
            var src = item.dataset.src
            if (src===''){
                return
            }
            var rect = item.getBoundingClientRect()
            if ( rect.bottom>=0 && rect.top < document.documentElement.clientHeight ){
                var img = new Image()
                img.src = src
                img.onload = function (){
                    item.src = img.src
                    // 性能优化，移除lazy标记
                    item.removeAttribute('lazy')
                    startLoadTransition(item)
                    // 删除骨架屏
                    removeSkeleton(item.parentElement)
                    img = null
                }
            }
        })
    }
    window.addEventListener("scroll",throttle(lazyload,100))
    function showLoading (){
        document.querySelector('.spinner').style.display = 'block'
    }
    function hideLoading (){
        document.querySelector('.spinner').style.display = 'none'
    }
    function showNextText(){
        document.querySelector('.next-page-text').style.display = 'block'
    }
    function hideNextText(){
        document.querySelector('.next-page-text').style.display = 'none'
    }
    
    document.querySelector('.next-page').addEventListener('click',()=>{
        hideNextText()
        showLoading()
        loadNewsData()
    })

    // 加载新闻列表
    function loadNewsData(){
        Object.assign( paging, {
            current:paging.current + 1,
            pageSize:10,
            total:paging.total
        })
        var newsHTML = []
        // 模拟接口返回时间
        setTimeout(function(){
            for ( let i =0; i < paging.pageSize; i++ ){
                paging.total++;
                Array.prototype.forEach.call(createNewsItem({
                    title: `今天是第${paging.total}天`,
                    text: `今天是第${paging.total}天,天气不错,去吃火锅还是烧烤呢？`,
                    src: getRandomSrc()
                }),function(node){
                    document.querySelector('.scroll').appendChild(node)
                    // 添加后主动触发
                    dispatchLazyImg()
                })
            }
            hideLoading()
            showNextText()
            console.log(`当前第${paging.current}页数,共${paging.total}条数据`)
        },1500)
    }
    
    // 节流函数
    function throttle(fn, delay) {
        let timer
        let prevTime
        return function (...args) {
            const currTime = Date.now()
            const context = this
            if (!prevTime){
                prevTime = currTime
            }
            clearTimeout(timer)
            if (currTime - prevTime > delay) {
                prevTime = currTime
                fn.apply(context, args)
                clearTimeout(timer)
                return
            }
            timer = setTimeout(function () {
                prevTime = Date.now()
                timer = null
                fn.apply(context, args)
            }, delay)
        }
    }
    
    // 主动触发图片加载
    function dispatchLazyImg(){
        var evt = window.document.createEvent('UIEvents');
        evt.initUIEvent('scroll', true, false, window, 0); 
        window.dispatchEvent(evt);
    }

    // 创建节点且返回子节点
    function createNewsItem ({
        title,
        text,
        src
    }){
        const placeholder = document.createElement('div')
        placeholder.innerHTML = `
        <div class="result-item-fullbox">
            <div class="result-item">
                <div class="result-item-content">
                    <div class="result-item-content-title">${title}</div>
                    <div class="result-item-content-text">${text}</div>
                </div>
                <div class="result-item-img skeleton">
                    <img lazy="true" data-src="${src}">
                </div>
                <div class="result-item-date">4周前</div>
            </div>
        </div>`;
        return placeholder.children
    }

    // 开始过渡动画
    function startLoadTransition(imgTarget){
        // 设置动画
        imgTarget.style.opacity = '1'
    }

    // 提出图片加载骨架图加载特效
    function removeSkeleton(target){
        target.classList.remove('skeleton')        
    }

    // 随机返回图片地址
    function getRandomSrc(){
        const srcs = [
            'https://t7.baidu.com/it/u=2291349828,4144427007&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=1819248061,230866778&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=1092574912,855301095&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=376303577,3502948048&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=810585695,3039658333&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=1700588201,792130339&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=2671101745,1413589787&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=2869268957,1721811479&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=1557229360,443641844&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=3078295664,4026667001&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=805456074,3405546217&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=3069651952,3707858927&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=3902551096,3717324701&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=4139900776,3950105079&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=3990204032,3996447558&fm=193&f=GIF',
            'https://t7.baidu.com/it/u=3876201379,2104650373&fm=193&f=GIF'
        ]
        return srcs[Math.floor(Math.random()*srcs.length)]
    }
})
</script>